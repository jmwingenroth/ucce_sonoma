---
title: "IDW model for short-term and long-term sensors"
author: "Jordan Wingenroth"
date: "May 31, 2018"
output: html_document
---

```{r knitr opts, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

```{r libraries}

library(tidyverse)
library(readxl)
library(lubridate)

```

# geographic data setup

It seemed to make the most sense to load the pm 2.5 data from longterm sensors at the same time since the lat/long was included in the same table. The pm 2.5 dataset was a large file (10 MB) since it included all October data for the entire state, so I filtered it to only include sites within ~1 deg of the centerpoint of sampling sites in Excel prior to adding to the project.

```{r load farm and sensor geographic data}

st_sensors <- read_csv(file = "../data/aq_sensors.csv")
st_sensors <- filter(st_sensors, `sensor class` == "short_term")

long_term_pm25 <- read_csv("../data/long_term_pm25.csv")
lt_sensors <-long_term_pm25 %>%
  distinct(name, .keep_all = TRUE) %>%
  transmute(name, "sensor class" = "long_term", latitude, longitude)

farms <- read_csv(file = "../data/farm_data.csv")
hysplit <- readxl::read_xlsx(path = "../data/HYSPLIT_data.xlsx")

all(sort(hysplit$Address)==sort(farms$address))

```

```{r tidy geographic data}

#farm

farms <- left_join(farms, hysplit, by = c("address" = "Address"))

farms <- farms %>%
  select(address, Key, long, lat, `Exposure (raw, final model, normalized)`, `Exposure (smoothed, final model, normalized)`, `Rank (raw)`, `Rank (smoothed)`)

rm(list = "hysplit")

#aq_sensors

aq_sensors <- rbind(lt_sensors, st_sensors)
rm(list = c("lt_sensors", "st_sensors"))
aq_sensors <- rename(aq_sensors, lat = latitude, long = longitude)

```

# map with farm sites and aq sensors

```{r map, fig.width=8, fig.height=8}

ggplot(NULL, aes(long, lat)) +
  geom_point(data = aq_sensors) +
  geom_text(data = aq_sensors, color = "black", alpha = .3, aes(label = name), hjust = "inward", vjust = "inward", size = 3) +
  geom_point(data = farms, color = "red") +
  geom_text(data = farms, color = "red", alpha = .3, aes(label = Key), hjust = "inward", vjust = "inward", size = 3) +
  coord_fixed()

```

We're lacking sensors to the northwest of the sites, but we have a good number to the southeast (Vacaville, Vallejo, Berkeley, SF, Oakland).

ARB 14 & 38 Riebli sites have incorrect GPS data???

#fix Riebli data

```{r fix}

aq_sensors[grep("Riebli", aq_sensors$name),]$lat <- 38.500
aq_sensors[grep("Riebli", aq_sensors$name),]$long <- -122.741

```


# PM 2.5 data setup

```{r load short term pm 2.5 data}

st_files <- list.files("../data/short_term_pm25", full.names = TRUE)
short_term_pm25 <- lapply(st_files, function(x) read_xlsx(x))
names(short_term_pm25) <- str_sub(st_files, 42, -20)
for (i in 1:length(short_term_pm25)) short_term_pm25[[i]] <- mutate(short_term_pm25[[i]], name = names(short_term_pm25[i]))
short_term_pm25 <- do.call(rbind, short_term_pm25)
short_term_pm25 <- select(short_term_pm25, name, everything())

sort(unique(short_term_pm25$name))==sort(aq_sensors[aq_sensors$`sensor class`=="short_term",]$name)

```

Some of the short term sensors have different, but easily matchable names.

```{r tidy pm 2.5 data}

#short-term times

short_term_pm25 <- short_term_pm25 %>%
  mutate(datetime = `Date/Time/` + 3600*hour(PST))


#long-term times

long_term_pm25 <- long_term_pm25 %>%
  mutate(date = as.POSIXct(long_term_pm25$date, format = "%m/%d/%Y"), datetime = date + 3600*start_hour)

#match sites to aq sensors by key

aq_sensors$key <- str_sub(aq_sensors$name, end = 10)
long_term_pm25$key <- str_sub(long_term_pm25$name, end = 10)
short_term_pm25$key <- str_sub(short_term_pm25$name, end = 10)

length(sort(unique(aq_sensors$key))==sort(c(unique(long_term_pm25$key), unique(short_term_pm25$key))))

#pull out and match up essential columns for purpose of rowbinding and joining

t1<-short_term_pm25 %>%
  select(key, name, datetime, value = ConcHr)

t2<-long_term_pm25 %>%
  select(key, name, datetime, value)

#rowbind and join to gps data

pm25 <- rbind(t1, t2)

pm25 <- left_join(pm25, aq_sensors, "key")

```

# graphs of sensor data

# model function

# run model

# model plots